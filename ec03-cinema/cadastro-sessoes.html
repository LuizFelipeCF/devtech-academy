<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cadastro de Sessões</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- menu -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Cinema</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="cadastro-filmes.html">Filmes</a></li>
          <li class="nav-item"><a class="nav-link" href="cadastro-salas.html">Salas</a></li>
          <li class="nav-item"><a class="nav-link active" href="cadastro-sessoes.html">Sessões</a></li>
          <li class="nav-item"><a class="nav-link" href="sessoes.html">Sessões Disponíveis</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container mt-4">
    <h2>Cadastro de Sessões</h2>
    <div id="alert-placeholder"></div>

    <form id="sessao-form" class="row g-3 needs-validation" novalidate>
      <div class="col-md-6">
        <label class="form-label">Filme</label>
        <select id="filme-select" class="form-select" required></select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Sala</label>
        <select id="sala-select" class="form-select" required></select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Data e Hora</label>
        <input id="datetime" type="datetime-local" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Preço (R$)</label>
        <input id="preco" type="number" step="0.01" min="0" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Idioma</label>
        <select id="idioma" class="form-select" required><option>Dublado</option><option>Legendado</option></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Formato</label>
        <select id="formato" class="form-select" required><option>2D</option><option>3D</option></select>
      </div>
      <div class="col-12">
        <button class="btn btn-primary">Salvar Sessão</button>
      </div>
    </form>

    <hr/>
    <h3>Sessões cadastradas</h3>
    <ul id="sessao-list" class="list-group"></ul>
  </main>

  <script src="cinema.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filmeSelect = document.getElementById('filme-select');
      const salaSelect = document.getElementById('sala-select');
      const form = document.getElementById('sessao-form');
      const list = document.getElementById('sessao-list');
      const alertPlaceholder = document.getElementById('alert-placeholder');

      const showAlert = (msg, type='success')=>{
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible`;
        div.innerHTML = msg + '<button class="btn-close" data-bs-dismiss="alert"></button>';
        alertPlaceholder.appendChild(div);
        setTimeout(()=>div.remove(),4000);
      };

      const populateSelects = () => {
        const filmes = Cinema.getFilmes();
        filmeSelect.innerHTML = filmes.length ? ('<option value="" disabled selected>Escolha um filme</option>' + filmes.map(f=>`<option value="${f.id}">${f.titulo}</option>`).join('')) : '<option value="" disabled selected>Nenhum filme</option>';

        const salas = Cinema.getSalas();
        salaSelect.innerHTML = salas.length ? ('<option value="" disabled selected>Escolha uma sala</option>' + salas.map(s=>`<option value="${s.id}">${s.nome} (${s.tipo})</option>`).join('')) : '<option value="" disabled selected>Nenhuma sala</option>';
      };

      const render = () => {
        const sessoes = Cinema.getSessoes();
        if (!sessoes.length) {
          list.innerHTML = '<li class="list-group-item">Nenhuma sessão cadastrada.</li>';
          return;
        }
        const filmes = Cinema.getFilmes();
        const salas = Cinema.getSalas();

        list.innerHTML = sessoes.map(sess => {
          const filme = filmes.find(f=>f.id===sess.filmeId);
          const sala = salas.find(s=>s.id===sess.salaId);
          return `<li class="list-group-item d-flex justify-content-between">
            <div>
              <strong>${filme?filme.titulo:'-'} </strong><br>
              <small>${sala? sala.nome:'-'} • ${Cinema.formatDateTime(sess.datetime)} • R$ ${sess.preco.toFixed(2)}</small>
            </div>
            <div>
              <button class="btn btn-danger btn-sm" data-id="${sess.id}" data-action="delete">Excluir</button>
            </div>
          </li>`;
        }).join('');
      };

      populateSelects();
      render();

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
        const filmeId = filmeSelect.value;
        const salaId = salaSelect.value;
        const datetimeLocal = document.getElementById('datetime').value;
        const preco = document.getElementById('preco').value;
        const idioma = document.getElementById('idioma').value;
        const formato = document.getElementById('formato').value;

        if (!filmeId || !salaId) { alert('Selecione filme e sala'); return; }

        // convert datetime-local to ISO
        const iso = new Date(datetimeLocal).toISOString();

        const sessoes = Cinema.getSessoes();
        const s = new Cinema.Sessao(Cinema.generateId('ss_'), filmeId, salaId, iso, preco, idioma, formato);
        sessoes.push(s);
        Cinema.setSessoes(sessoes);

        showAlert('Sessão cadastrada com sucesso!', 'success');
        form.reset(); form.classList.remove('was-validated');
        populateSelects();
        render();
      });

      list.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.dataset.action === 'delete') {
          if (confirm('Excluir sessão?')) {
            let sessoes = Cinema.getSessoes();
            sessoes = sessoes.filter(s=>s.id!==id);
            Cinema.setSessoes(sessoes);
            render();
          }
        }
      });

      // repopula selects sempre que a aba ficar visível (ex: volta de outra página)
      window.addEventListener('focus', populateSelects);
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
