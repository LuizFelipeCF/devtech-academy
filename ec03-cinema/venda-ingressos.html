<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Venda de Ingressos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- menu -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Cinema</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="cadastro-filmes.html">Filmes</a></li>
          <li class="nav-item"><a class="nav-link" href="cadastro-salas.html">Salas</a></li>
          <li class="nav-item"><a class="nav-link" href="cadastro-sessoes.html">Sessões</a></li>
          <li class="nav-item"><a class="nav-link" href="sessoes.html">Sessões Disponíveis</a></li>
          <li class="nav-item"><a class="nav-link active" href="venda-ingressos.html">Venda</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container mt-4">
    <h2>Venda de Ingressos</h2>
    <div id="alert-placeholder"></div>

    <form id="ticket-form" class="row g-3 needs-validation" novalidate>
      <div class="col-md-6">
        <label class="form-label">Sessão</label>
        <select id="session-select" class="form-select" required></select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Nome do Cliente</label>
        <input id="cliente" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">CPF</label>
        <input id="cpf" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Assento (ex: A10)</label>
        <input id="assento" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Tipo de Pagamento</label>
        <select id="pagamento" class="form-select" required>
          <option>Cartão</option><option>Pix</option><option>Dinheiro</option>
        </select>
      </div>
      <div class="col-12">
        <button class="btn btn-success">Confirmar Venda</button>
      </div>
    </form>

    <hr/>
    <h3>Vendas realizadas</h3>
    <ul id="sales-list" class="list-group"></ul>
  </main>

  <script src="cinema.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sessionSelect = document.getElementById('session-select');
      const form = document.getElementById('ticket-form');
      const salesList = document.getElementById('sales-list');
      const alertPlaceholder = document.getElementById('alert-placeholder');

      const showAlert = (msg, type='success')=>{
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible`;
        div.innerHTML = msg + '<button class="btn-close" data-bs-dismiss="alert"></button>';
        alertPlaceholder.appendChild(div);
        setTimeout(()=>div.remove(),4000);
      };

      const populateSessions = () => {
        const sessoes = Cinema.getSessoes();
        const filmes = Cinema.getFilmes();
        const salas = Cinema.getSalas();
        if (!sessoes.length) {
          sessionSelect.innerHTML = '<option value="" disabled selected>Nenhuma sessão</option>';
          return;
        }
        sessionSelect.innerHTML = '<option value="" disabled selected>Selecione uma sessão</option>' + sessoes.map(s=>{
          const f = filmes.find(x=>x.id===s.filmeId);
          const sal = salas.find(x=>x.id===s.salaId);
          return `<option value="${s.id}">${f?f.titulo:'-'} — ${sal?sal.nome:'-'} — ${Cinema.formatDateTime(s.datetime)} — R$${s.preco.toFixed(2)}</option>`;
        }).join('');
      };

      const renderSales = () => {
        const ingressos = Cinema.getIngressos();
        salesList.innerHTML = ingressos.length ? ingressos.map(i => {
          const sess = Cinema.getSessoes().find(s=>s.id===i.sessaoId);
          const filme = Cinema.getFilmes().find(f=>f.id=== (sess? sess.filmeId : null));
          return `<li class="list-group-item"><strong>${i.cliente}</strong> — ${i.assento} — ${filme?filme.titulo:'-'} — ${new Date(i.vendidoEm).toLocaleString()}</li>`;
        }).join('') : '<li class="list-group-item">Nenhuma venda registrada.</li>';
      };

      // Preselect session if sessionId param present
      const params = Cinema.getQueryParams();
      const preSessionId = params.sessionId;

      populateSessions();
      if (preSessionId) {
        // If the session exists, select it
        const opt = Array.from(sessionSelect.options).find(o=>o.value===preSessionId);
        if (opt) opt.selected = true;
      }
      renderSales();

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.classList.add('was-validated'); return; }

        const sessaoId = sessionSelect.value;
        const cliente = document.getElementById('cliente').value.trim();
        const cpf = document.getElementById('cpf').value.trim();
        const assento = document.getElementById('assento').value.trim();
        const pagamento = document.getElementById('pagamento').value;

        if (!sessaoId) { alert('Selecione uma sessão'); return; }

        const ingressos = Cinema.getIngressos();
        const ingresso = new Cinema.Ingresso(Cinema.generateId('i_'), sessaoId, cliente, cpf, assento, pagamento, new Date().toISOString());
        ingressos.push(ingresso);
        Cinema.setIngressos(ingressos);

        showAlert('Venda registrada com sucesso!', 'success');
        form.reset(); form.classList.remove('was-validated');
        renderSales();
      });

      // update lists when returning to page
      window.addEventListener('focus', ()=>{ populateSessions(); renderSales(); });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
